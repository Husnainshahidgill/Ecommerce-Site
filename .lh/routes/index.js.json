{
    "sourceFile": "routes/index.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1765399865331,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1765445676015,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,16 +22,20 @@\n     req.flash('danger', 'Invalid Password');\r\n     return res.redirect('/login');\r\n   }\r\n });\r\n+\r\n router.get('/register', function (req, res, next) {\r\n   return res.render('site/register');\r\n });\r\n+\r\n+\r\n router.get('/logout', async (req, res) => {\r\n   req.session.user = null;\r\n   console.log('session clear');\r\n   return res.redirect('/login');\r\n });\r\n+\r\n // router.post(\"/register\", async function (req, res, next) {\r\n //   let user = await User.findOne({ email: req.body.email });\r\n //   if (user) {\r\n //     req.flash(\"danger\", \"User with given email already registered\");\r\n@@ -43,9 +47,12 @@\n \r\n //   await user.save();\r\n //   return res.redirect(\"/login\");\r\n // });\r\n+\r\n router.post('/register', async function (req, res, next) {\r\n+\r\n+  //check duplicate email\r\n   let user = await User.findOne({ email: req.body.email });\r\n   if (user) {\r\n     req.flash('danger', 'User with given email already registered');\r\n     return res.redirect('/register');\r\n@@ -54,10 +61,12 @@\n   // ✅ Only pick safe fields\r\n   user = new User({\r\n     name: req.body.name,\r\n     email: req.body.email,\r\n-    // ✅ Force default role on server\r\n+    // ✅ Force default role on server. This guarantees that no matter what data a hacker tries to inject into the form,\r\n+    //  every new registration starts as a basic customer.\r\n     roles: ['customer'],\r\n+\r\n   });\r\n \r\n   const salt = await bcrypt.genSalt(10);\r\n   user.password = await bcrypt.hash(req.body.password, salt);\r\n"
                },
                {
                    "date": 1766092343458,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,9 +14,14 @@\n     return res.redirect('/login');\r\n   }\r\n   const validPassword = await bcrypt.compare(req.body.password, user.password);\r\n   if (validPassword) {\r\n-    req.session.user = user;\r\n+    req.session.user = {\r\n+  _id: user._id,\r\n+  name: user.name,\r\n+  email: user.email,\r\n+  roles: user.roles || [],\r\n+};\r\n     req.flash('success', 'Logged in Successfully');\r\n     return res.redirect('/');\r\n   } else {\r\n     req.flash('danger', 'Invalid Password');\r\n"
                }
            ],
            "date": 1765399865331,
            "name": "Commit-0",
            "content": "var express = require(\"express\");\r\nvar router = express.Router();\r\nvar Product = require(\"../models/Product\");\r\nconst User = require(\"../models/User\");\r\nconst bcrypt = require(\"bcryptjs\");\r\n/* GET home page. */\r\nrouter.get(\"/login\", function (req, res, next) {\r\n  return res.render(\"site/login\");\r\n});\r\nrouter.post(\"/login\", async function (req, res, next) {\r\n  let user = await User.findOne({ email: req.body.email });\r\n  if (!user) {\r\n    req.flash(\"danger\", \"User with this email not present\");\r\n    return res.redirect(\"/login\");\r\n  }\r\n  const validPassword = await bcrypt.compare(req.body.password, user.password);\r\n  if (validPassword) {\r\n    req.session.user = user;\r\n    req.flash(\"success\", \"Logged in Successfully\");\r\n    return res.redirect(\"/\");\r\n  } else {\r\n    req.flash(\"danger\", \"Invalid Password\");\r\n    return res.redirect(\"/login\");\r\n  }\r\n});\r\nrouter.get(\"/register\", function (req, res, next) {\r\n  return res.render(\"site/register\");\r\n});\r\nrouter.get(\"/logout\", async (req, res) => {\r\n  req.session.user = null;\r\n  console.log(\"session clear\");\r\n  return res.redirect(\"/login\");\r\n});\r\n// router.post(\"/register\", async function (req, res, next) {\r\n//   let user = await User.findOne({ email: req.body.email });\r\n//   if (user) {\r\n//     req.flash(\"danger\", \"User with given email already registered\");\r\n//     return res.redirect(\"/register\");\r\n//   }\r\n//   user = new User(req.body);\r\n//   const salt = await bcrypt.genSalt(10);\r\n//   user.password = await bcrypt.hash(req.body.password, salt);\r\n\r\n//   await user.save();\r\n//   return res.redirect(\"/login\");\r\n// });\r\nrouter.post(\"/register\", async function (req, res, next) {\r\n  let user = await User.findOne({ email: req.body.email });\r\n  if (user) {\r\n    req.flash(\"danger\", \"User with given email already registered\");\r\n    return res.redirect(\"/register\");\r\n  }\r\n\r\n  // ✅ Only pick safe fields\r\n  user = new User({\r\n    name: req.body.name,\r\n    email: req.body.email,\r\n    // ✅ Force default role on server\r\n    roles: [\"customer\"],\r\n  });\r\n\r\n  const salt = await bcrypt.genSalt(10);\r\n  user.password = await bcrypt.hash(req.body.password, salt);\r\n\r\n  await user.save();\r\n  req.flash(\"success\", \"Registered Successfully. Please login.\");\r\n  return res.redirect(\"/login\");\r\n});\r\n\r\nrouter.get(\"/contact-us\", function (req, res, next) {\r\n  return res.render(\"site/contact\", { layout: \"layout\" });\r\n});\r\n\r\nmodule.exports = router;\r\n"
        }
    ]
}